
R version 3.4.3 (2017-11-30) -- "Kite-Eating Tree"
Copyright (C) 2017 The R Foundation for Statistical Computing
Platform: x86_64-apple-darwin17.3.0 (64-bit)

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> ### test file for etmCIF.
> ### Really simple tests and comparison with etm
> 
> require(etm)
Loading required package: etm
> 
> if (!require(survival, quietly = TRUE))
+     stop("The following tests require the 'survival' package")
> 
> 
> data(abortion)
> 
> from <- rep(0, nrow(abortion))
> to <- abortion$cause
> entry <- abortion$entry
> exit <- abortion$exit
> id <- 1:nrow(abortion)
> data <- data.frame(id, from, to, entry, exit, group = abortion$group)
> 
> ## Computation of the CIFs with etm
> tra <- matrix(FALSE, 4, 4)
> tra[1, 2:4] <- TRUE
> 
> cif.control <- etm(data[data$group == 0, ], c("0", "1", "2", "3"),
+                         tra, NULL, 0)
> cif.exposed <- etm(data[data$group == 1, ], c("0", "1", "2", "3"),
+                         tra, NULL, 0)
> 
> 
> ## Computation of the CIFs with etmCIF
> netm <- etmCIF(Surv(entry, exit, cause != 0) ~ group, abortion,
+                etype = cause, failcode = 3)
> 
> ### let's do some comparisons :-)
> 
> all.equal(trprob(cif.control, "0 3"), netm[[1]]$est["0", "3", ])
[1] TRUE
> all.equal(trprob(cif.control, "0 2"), netm[[1]]$est["0", "2", ])
[1] TRUE
> all.equal(trprob(cif.control, "0 1"), netm[[1]]$est["0", "1", ])
[1] TRUE
> 
> all.equal(trprob(cif.exposed, "0 3"), netm[[2]]$est["0", "3", ])
[1] TRUE
> all.equal(trprob(cif.exposed, "0 2"), netm[[2]]$est["0", "2", ])
[1] TRUE
> all.equal(trprob(cif.exposed, "0 1"), netm[[2]]$est["0", "1", ])
[1] TRUE
> 
> 
> all.equal(trcov(cif.control, "0 3"), netm[[1]]$cov["0 3", "0 3", ])
[1] TRUE
> all.equal(trcov(cif.control, "0 2"), netm[[1]]$cov["0 2", "0 2", ])
[1] TRUE
> all.equal(trcov(cif.control, "0 1"), netm[[1]]$cov["0 1", "0 1", ])
[1] TRUE
> 
> all.equal(trcov(cif.exposed, "0 3"), netm[[2]]$cov["0 3", "0 3", ])
[1] TRUE
> all.equal(trcov(cif.exposed, "0 2"), netm[[2]]$cov["0 2", "0 2", ])
[1] TRUE
> all.equal(trcov(cif.exposed, "0 1"), netm[[2]]$cov["0 1", "0 1", ])
[1] TRUE
> 
> 
> netm
Call: etmCIF(formula = Surv(entry, exit, cause != 0) ~ group, data = abortion, 
    etype = cause, failcode = 3)

Covariate:  group 
	levels:  0 1 


 group = 0 
      time          P       se(P) n.event
CIF 1   43 0.04015931 0.009257784      20
CIF 2   43 0.79905931 0.022186468     924
CIF 3   43 0.16078139 0.021326113      69

 group = 1 
      time         P      se(P) n.event
CIF 1   42 0.2851118 0.04249308      38
CIF 2   42 0.3525651 0.04213898      92
CIF 3   42 0.3623231 0.04947340      43
> 
> ## test on the summary
> snetm <- summary(netm)
> 
> snetm

	 group=0 

CIF 1 
          P time          var      lower      upper n.risk n.event
 0.00000000    6 0.000000e+00 0.00000000 0.00000000    117       0
 0.03895488   13 8.444048e-05 0.02448808 0.06169378    645       1
 0.04015931   26 8.570657e-05 0.02551262 0.06293875    846       0
 0.04015931   36 8.570657e-05 0.02551262 0.06293875    876       0
 0.04015931   40 8.570657e-05 0.02551262 0.06293875    554       0
 0.04015931   43 8.570657e-05 0.02551262 0.06293875      6       0

CIF 2 
          P time          var      lower      upper n.risk n.event
 0.00000000    6 0.0000000000 0.00000000 0.00000000    117       0
 0.00000000   13 0.0000000000 0.00000000 0.00000000    645       0
 0.00000000   26 0.0000000000 0.00000000 0.00000000    846       0
 0.05319709   36 0.0000461946 0.04137897 0.06826844    876      25
 0.56312087   40 0.0003880102 0.52492372 0.60202137    554     280
 0.79905931   43 0.0004922394 0.75396884 0.84061317      6       6

CIF 3 
          P time          var      lower      upper n.risk n.event
 0.03418803    6 0.0002822155 0.01297036 0.08852307    117       4
 0.15046750   13 0.0004551293 0.11359698 0.19790133    645       1
 0.15990390   26 0.0004549788 0.12273893 0.20692473    846       1
 0.16078139   36 0.0004548031 0.12359648 0.20775707    876       1
 0.16078139   40 0.0004548031 0.12359648 0.20775707    554       0
 0.16078139   43 0.0004548031 0.12359648 0.20775707      6       0


	 group=1 

CIF 1 
         P time         var     lower     upper n.risk n.event
 0.0000000    6 0.000000000 0.0000000 0.0000000     35       0
 0.2604775   13 0.001785362 0.1879526 0.3542503     90       0
 0.2811533   21 0.001802770 0.2074197 0.3742279     93       1
 0.2851118   34 0.001805662 0.2111650 0.3780568     89       0
 0.2851118   39 0.001805662 0.2111650 0.3780568     59       0
 0.2851118   42 0.001805662 0.2111650 0.3780568      6       0

CIF 2 
          P time          var      lower     upper n.risk n.event
 0.00000000    6 0.000000e+00 0.00000000 0.0000000     35       0
 0.00000000   13 0.000000e+00 0.00000000 0.0000000     90       0
 0.00000000   21 0.000000e+00 0.00000000 0.0000000     93       0
 0.02307296   34 9.051425e-05 0.01025212 0.0515043     89       2
 0.18015642   39 8.012639e-04 0.13176471 0.2436631     59      13
 0.35256510   42 1.775693e-03 0.27688207 0.4417747      6       6

CIF 3 
          P time         var      lower     upper n.risk n.event
 0.05714286    6 0.001539359 0.01460522 0.2096798     35       2
 0.33324586   13 0.002528042 0.24533656 0.4421570     90       4
 0.35070194   21 0.002482739 0.26276916 0.4576195     93       0
 0.35849179   34 0.002459261 0.27062662 0.4644770     89       0
 0.35849179   39 0.002459261 0.27062662 0.4644770     59       0
 0.36232310   42 0.002447617 0.27449870 0.4678544      6       0

> 
> all.equal(unname(trprob(cif.control, "0 3")), snetm[[1]][[3]]$P)
[1] TRUE
> all.equal(unname(trprob(cif.control, "0 2")), snetm[[1]][[2]]$P)
[1] TRUE
> all.equal(unname(trprob(cif.control, "0 1")), snetm[[1]][[1]]$P)
[1] TRUE
> 
> all.equal(unname(trprob(cif.exposed, "0 3")), snetm[[2]][[3]]$P)
[1] TRUE
> all.equal(unname(trprob(cif.exposed, "0 2")), snetm[[2]][[2]]$P)
[1] TRUE
> all.equal(unname(trprob(cif.exposed, "0 1")), snetm[[2]][[1]]$P)
[1] TRUE
> 
> scif.control <- summary(cif.control, ci.fun = "cloglog")
> scif.exposed <- summary(cif.exposed, ci.fun = "cloglog")
> 
> all.equal(scif.control[[4]]$lower, snetm[[1]][[3]]$lower)
[1] TRUE
> all.equal(scif.control[[4]]$upper, snetm[[1]][[3]]$upper)
[1] TRUE
> 
> all.equal(scif.exposed[[4]]$lower, snetm[[2]][[3]]$lower)
[1] TRUE
> all.equal(scif.exposed[[4]]$upper, snetm[[2]][[3]]$upper)
[1] TRUE
> 
> 
> ### test with factors in the input
> abortion$status <- with(abortion, ifelse(cause == 2, "life birth",
+                                          ifelse(cause == 1, "ETOP", "spontaneous abortion")))
> 
> abortion$status <- factor(abortion$status)
> 
> netm.factor <- etmCIF(Surv(entry, exit, status != "cens") ~ group, abortion,
+                       etype = status, failcode = "spontaneous abortion")
> 
> 
> all.equal(trprob(cif.control, "0 3"), netm.factor[[1]]$est["0", "spontaneous abortion", ])
[1] TRUE
> all.equal(trprob(cif.control, "0 2"), netm.factor[[1]]$est["0", "life birth", ])
[1] TRUE
> 
> netm.factor
Call: etmCIF(formula = Surv(entry, exit, status != "cens") ~ group, 
    data = abortion, etype = status, failcode = "spontaneous abortion")

Covariate:  group 
	levels:  0 1 


 group = 0 
                         time          P       se(P) n.event
CIF ETOP                   43 0.04015931 0.009257784      20
CIF life birth             43 0.79905931 0.022186468     924
CIF spontaneous abortion   43 0.16078139 0.021326113      69

 group = 1 
                         time         P      se(P) n.event
CIF ETOP                   42 0.2851118 0.04249308      38
CIF life birth             42 0.3525651 0.04213898      92
CIF spontaneous abortion   42 0.3623231 0.04947340      43
> 
> summary(netm.factor)

	 group=0 

CIF ETOP 
          P time          var      lower      upper n.risk n.event
 0.00000000    6 0.000000e+00 0.00000000 0.00000000    117       0
 0.03895488   13 8.444048e-05 0.02448808 0.06169378    645       1
 0.04015931   26 8.570657e-05 0.02551262 0.06293875    846       0
 0.04015931   36 8.570657e-05 0.02551262 0.06293875    876       0
 0.04015931   40 8.570657e-05 0.02551262 0.06293875    554       0
 0.04015931   43 8.570657e-05 0.02551262 0.06293875      6       0

CIF life birth 
          P time          var      lower      upper n.risk n.event
 0.00000000    6 0.0000000000 0.00000000 0.00000000    117       0
 0.00000000   13 0.0000000000 0.00000000 0.00000000    645       0
 0.00000000   26 0.0000000000 0.00000000 0.00000000    846       0
 0.05319709   36 0.0000461946 0.04137897 0.06826844    876      25
 0.56312087   40 0.0003880102 0.52492372 0.60202137    554     280
 0.79905931   43 0.0004922394 0.75396884 0.84061317      6       6

CIF spontaneous abortion 
          P time          var      lower      upper n.risk n.event
 0.03418803    6 0.0002822155 0.01297036 0.08852307    117       4
 0.15046750   13 0.0004551293 0.11359698 0.19790133    645       1
 0.15990390   26 0.0004549788 0.12273893 0.20692473    846       1
 0.16078139   36 0.0004548031 0.12359648 0.20775707    876       1
 0.16078139   40 0.0004548031 0.12359648 0.20775707    554       0
 0.16078139   43 0.0004548031 0.12359648 0.20775707      6       0


	 group=1 

CIF ETOP 
         P time         var     lower     upper n.risk n.event
 0.0000000    6 0.000000000 0.0000000 0.0000000     35       0
 0.2604775   13 0.001785362 0.1879526 0.3542503     90       0
 0.2811533   21 0.001802770 0.2074197 0.3742279     93       1
 0.2851118   34 0.001805662 0.2111650 0.3780568     89       0
 0.2851118   39 0.001805662 0.2111650 0.3780568     59       0
 0.2851118   42 0.001805662 0.2111650 0.3780568      6       0

CIF life birth 
          P time          var      lower     upper n.risk n.event
 0.00000000    6 0.000000e+00 0.00000000 0.0000000     35       0
 0.00000000   13 0.000000e+00 0.00000000 0.0000000     90       0
 0.00000000   21 0.000000e+00 0.00000000 0.0000000     93       0
 0.02307296   34 9.051425e-05 0.01025212 0.0515043     89       2
 0.18015642   39 8.012639e-04 0.13176471 0.2436631     59      13
 0.35256510   42 1.775693e-03 0.27688207 0.4417747      6       6

CIF spontaneous abortion 
          P time         var      lower     upper n.risk n.event
 0.05714286    6 0.001539359 0.01460522 0.2096798     35       2
 0.33324586   13 0.002528042 0.24533656 0.4421570     90       4
 0.35070194   21 0.002482739 0.26276916 0.4576195     93       0
 0.35849179   34 0.002459261 0.27062662 0.4644770     89       0
 0.35849179   39 0.002459261 0.27062662 0.4644770     59       0
 0.36232310   42 0.002447617 0.27449870 0.4678544      6       0

> 
> ### test with group as a character vector
> abortion$ttt <- with(abortion, ifelse(group == 0, "control", "exposed"))
> abortion$ttt <- factor(abortion$ttt)
> 
> netm.ttt <- etmCIF(Surv(entry, exit, status != "cens") ~ ttt, abortion,
+                    etype = status, failcode = "spontaneous abortion")
> 
> all.equal(trprob(cif.control, "0 3"), netm.ttt[[1]]$est["0", "spontaneous abortion", ])
[1] TRUE
> all.equal(trprob(cif.control, "0 2"), netm.ttt[[1]]$est["0", "life birth", ])
[1] TRUE
> 
> netm.ttt
Call: etmCIF(formula = Surv(entry, exit, status != "cens") ~ ttt, data = abortion, 
    etype = status, failcode = "spontaneous abortion")

Covariate:  ttt 
	levels:  control exposed 


 ttt = control 
                         time          P       se(P) n.event
CIF ETOP                   43 0.04015931 0.009257784      20
CIF life birth             43 0.79905931 0.022186468     924
CIF spontaneous abortion   43 0.16078139 0.021326113      69

 ttt = exposed 
                         time         P      se(P) n.event
CIF ETOP                   42 0.2851118 0.04249308      38
CIF life birth             42 0.3525651 0.04213898      92
CIF spontaneous abortion   42 0.3623231 0.04947340      43
> 
> summary(netm.ttt)

	 ttt=control 

CIF ETOP 
          P time          var      lower      upper n.risk n.event
 0.00000000    6 0.000000e+00 0.00000000 0.00000000    117       0
 0.03895488   13 8.444048e-05 0.02448808 0.06169378    645       1
 0.04015931   26 8.570657e-05 0.02551262 0.06293875    846       0
 0.04015931   36 8.570657e-05 0.02551262 0.06293875    876       0
 0.04015931   40 8.570657e-05 0.02551262 0.06293875    554       0
 0.04015931   43 8.570657e-05 0.02551262 0.06293875      6       0

CIF life birth 
          P time          var      lower      upper n.risk n.event
 0.00000000    6 0.0000000000 0.00000000 0.00000000    117       0
 0.00000000   13 0.0000000000 0.00000000 0.00000000    645       0
 0.00000000   26 0.0000000000 0.00000000 0.00000000    846       0
 0.05319709   36 0.0000461946 0.04137897 0.06826844    876      25
 0.56312087   40 0.0003880102 0.52492372 0.60202137    554     280
 0.79905931   43 0.0004922394 0.75396884 0.84061317      6       6

CIF spontaneous abortion 
          P time          var      lower      upper n.risk n.event
 0.03418803    6 0.0002822155 0.01297036 0.08852307    117       4
 0.15046750   13 0.0004551293 0.11359698 0.19790133    645       1
 0.15990390   26 0.0004549788 0.12273893 0.20692473    846       1
 0.16078139   36 0.0004548031 0.12359648 0.20775707    876       1
 0.16078139   40 0.0004548031 0.12359648 0.20775707    554       0
 0.16078139   43 0.0004548031 0.12359648 0.20775707      6       0


	 ttt=exposed 

CIF ETOP 
         P time         var     lower     upper n.risk n.event
 0.0000000    6 0.000000000 0.0000000 0.0000000     35       0
 0.2604775   13 0.001785362 0.1879526 0.3542503     90       0
 0.2811533   21 0.001802770 0.2074197 0.3742279     93       1
 0.2851118   34 0.001805662 0.2111650 0.3780568     89       0
 0.2851118   39 0.001805662 0.2111650 0.3780568     59       0
 0.2851118   42 0.001805662 0.2111650 0.3780568      6       0

CIF life birth 
          P time          var      lower     upper n.risk n.event
 0.00000000    6 0.000000e+00 0.00000000 0.0000000     35       0
 0.00000000   13 0.000000e+00 0.00000000 0.0000000     90       0
 0.00000000   21 0.000000e+00 0.00000000 0.0000000     93       0
 0.02307296   34 9.051425e-05 0.01025212 0.0515043     89       2
 0.18015642   39 8.012639e-04 0.13176471 0.2436631     59      13
 0.35256510   42 1.775693e-03 0.27688207 0.4417747      6       6

CIF spontaneous abortion 
          P time         var      lower     upper n.risk n.event
 0.05714286    6 0.001539359 0.01460522 0.2096798     35       2
 0.33324586   13 0.002528042 0.24533656 0.4421570     90       4
 0.35070194   21 0.002482739 0.26276916 0.4576195     93       0
 0.35849179   34 0.002459261 0.27062662 0.4644770     89       0
 0.35849179   39 0.002459261 0.27062662 0.4644770     59       0
 0.36232310   42 0.002447617 0.27449870 0.4678544      6       0

> 
> 
> ### A couple of comparisons with simulated data
> set.seed(1313)
> time <- rexp(100)
> to <- rbinom(100, 2, prob = c(1/3, 1/3, 1/3))
> from <- rep(11, 100)
> id <- 1:100
> cov <- rbinom(100, 1, 0.5)
> 
> dat.s <- data.frame(id, time, from, to, cov)
> 
> traa <- matrix(FALSE, 3, 3)
> traa[1, 2:3] <- TRUE
> 
> aa0 <- etm(dat.s[dat.s$cov == 0, ], c("11", "1", "2"), traa, "0", 0)
> aa1 <- etm(dat.s[dat.s$cov == 1, ], c("11", "1", "2"), traa, "0", 0)
> aa <- etm(dat.s, c("11", "1", "2"), traa, "0", 0)
> 
> test <- etmCIF(Surv(time, to != 0) ~ 1, dat.s, etype = to)
> 
> test.c <- etmCIF(Surv(time, to != 0) ~ cov, dat.s, etype = to)
> 
> all.equal(trprob(aa, "11 1"), test[[1]]$est["0", "1", ])
[1] TRUE
> all.equal(trprob(aa, "11 2"), test[[1]]$est["0", "2", ])
[1] TRUE
> 
> all.equal(trprob(aa0, "11 1"), test.c[[1]]$est["0", "1", ])
[1] TRUE
> all.equal(trprob(aa0, "11 2"), test.c[[1]]$est["0", "2", ])
[1] TRUE
> 
> all.equal(trprob(aa1, "11 1"), test.c[[2]]$est["0", "1", ])
[1] TRUE
> all.equal(trprob(aa1, "11 2"), test.c[[2]]$est["0", "2", ])
[1] TRUE
> 
> test
Call: etmCIF(formula = Surv(time, to != 0) ~ 1, data = dat.s, etype = to)

          time          P      se(P) n.event
CIF 1 4.908756 0.80910809 0.07968014      45
CIF 2 4.908756 0.09661788 0.03290520       8
> 
> test.c
Call: etmCIF(formula = Surv(time, to != 0) ~ cov, data = dat.s, etype = to)

Covariate:  cov 
	levels:  0 1 


 cov = 0 
          time         P      se(P) n.event
CIF 1 2.170838 0.7024648 0.10579670      19
CIF 2 2.170838 0.1114404 0.05338408       4

 cov = 1 
          time          P      se(P) n.event
CIF 1 4.908756 0.80787111 0.09405073      26
CIF 2 4.908756 0.08436022 0.04076920       4
> 
> summary(test)

	  

CIF 1 
         P        time         var       lower     upper n.risk n.event
 0.0100000 0.009209855 0.000099000 0.001414712 0.0688628    100       1
 0.1142996 0.266309576 0.001054230 0.064945430 0.1969931     81       1
 0.2345052 0.730309114 0.002043578 0.159110723 0.3377359     54       1
 0.4042535 1.429993902 0.003299558 0.302044531 0.5257406     29       1
 0.5459264 2.064720550 0.004083561 0.426900791 0.6736053     16       1
 0.8091081 4.908756124 0.006348924 0.635954424 0.9337329      2       1

CIF 2 
          P        time          var      lower      upper n.risk n.event
 0.00000000 0.009209855 0.0000000000 0.00000000 0.00000000    100       0
 0.03165655 0.266309576 0.0003235331 0.01031976 0.09494197     81       0
 0.06702937 0.730309114 0.0007036620 0.03059797 0.14350329     54       0
 0.09661788 1.429993902 0.0010827519 0.04908158 0.18547384     29       0
 0.09661788 2.064720550 0.0010827519 0.04908158 0.18547384     16       0
 0.09661788 4.908756124 0.0010827519 0.04908158 0.18547384      2       0

> summary(test.c)

	 cov=0 

CIF 1 
          P        time          var      lower     upper n.risk n.event
 0.02222222 0.009209855 0.0004828532 0.00316047 0.1474667     45       1
 0.09222222 0.298243881 0.0019360322 0.03559707 0.2276215     36       0
 0.22668442 0.702193811 0.0045095420 0.12417599 0.3925031     24       1
 0.37812821 1.429993902 0.0076087042 0.23378837 0.5714487     13       1
 0.50573606 1.614877369 0.0089532991 0.33884250 0.6988538     10       1
 0.70246483 2.170837510 0.0111929419 0.49448899 0.8839905      3       1

CIF 2 
          P        time         var      lower     upper n.risk n.event
 0.00000000 0.009209855 0.000000000 0.00000000 0.0000000     45       0
 0.04844136 0.298243881 0.001116811 0.01233703 0.1801316     36       1
 0.07641078 0.702193811 0.001810437 0.02520184 0.2192780     24       0
 0.11144039 1.429993902 0.002849860 0.04267633 0.2739153     13       0
 0.11144039 1.614877369 0.002849860 0.04267633 0.2739153     10       0
 0.11144039 2.170837510 0.002849860 0.04267633 0.2739153      3       0


	 cov=1 

CIF 1 
          P       time         var       lower     upper n.risk n.event
 0.01818182 0.06669232 0.000324568 0.002581315 0.1221376     55       1
 0.11239207 0.26380826 0.001872153 0.052092454 0.2333329     45       1
 0.24102340 0.73030911 0.003744989 0.144005730 0.3868459     31       1
 0.40120111 1.06691283 0.005707884 0.271400752 0.5642123     19       1
 0.59233377 2.36627489 0.007759845 0.428622952 0.7627259      8       1
 0.80787111 4.90875612 0.008845539 0.602318537 0.9477134      2       1

CIF 2 
          P       time          var       lower     upper n.risk n.event
 0.00000000 0.06669232 0.0000000000 0.000000000 0.0000000     55       0
 0.03743357 0.26380826 0.0006745784 0.009493953 0.1415172     45       0
 0.05934134 0.73030911 0.0011129497 0.019446521 0.1735097     31       0
 0.08436022 1.06691283 0.0016621276 0.032211300 0.2111908     19       0
 0.08436022 2.36627489 0.0016621276 0.032211300 0.2111908      8       0
 0.08436022 4.90875612 0.0016621276 0.032211300 0.2111908      2       0

> 
> proc.time()
   user  system elapsed 
  1.759   0.102   1.752 
